<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>前言 | 团队博客</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/blog/assets/css/0.styles.9957f12e.css" as="style"><link rel="preload" href="/blog/assets/js/app.5ecd04e8.js" as="script"><link rel="preload" href="/blog/assets/js/2.7a69aa7d.js" as="script"><link rel="preload" href="/blog/assets/js/14.85d14865.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.88739779.js"><link rel="prefetch" href="/blog/assets/js/11.0ce02956.js"><link rel="prefetch" href="/blog/assets/js/12.36f8af10.js"><link rel="prefetch" href="/blog/assets/js/13.e452ae47.js"><link rel="prefetch" href="/blog/assets/js/15.5f8083c4.js"><link rel="prefetch" href="/blog/assets/js/3.4a4f9563.js"><link rel="prefetch" href="/blog/assets/js/4.bb3de599.js"><link rel="prefetch" href="/blog/assets/js/5.6800896f.js"><link rel="prefetch" href="/blog/assets/js/6.7ce7dc99.js"><link rel="prefetch" href="/blog/assets/js/7.f378d7ae.js"><link rel="prefetch" href="/blog/assets/js/8.a265be1a.js"><link rel="prefetch" href="/blog/assets/js/9.28053ab4.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.9957f12e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">团队博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>GIT指南</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/kviksk.html" class="sidebar-link">GIT常用命令</a></li><li><a href="/blog/gus3op.html" class="sidebar-link">GIT最佳实践</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>软技能</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/tbbqx8.html" class="sidebar-link">编程修养</a></li><li><a href="/blog/wuyvak.html" class="sidebar-link">搜索技巧</a></li><li><a href="/blog/yalowt.html" class="sidebar-link">金字塔原理在Github PR中的运用</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>编程回忆录</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/zkpn6d.html" class="sidebar-link">交付可用的功能，许下承诺负责到底</a></li></ul></section></li><li><a href="/blog/bocbyc.html" class="sidebar-link">编码技巧</a></li><li><section class="sidebar-group depth-0"><a href="/blog/bx71vi.html" class="sidebar-heading clickable router-link-exact-active router-link-active active"><span>Github集成Travis CI</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/cmlu6m.html" class="sidebar-link">经验法则与至理名言</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="content default"><h1 id="前言"><a href="#前言" aria-hidden="true" class="header-anchor">#</a> 前言</h1> <p>已经有阮一峰老师的<a href="http://www.ruanyifeng.com/blog/2017/12/travis_ci_tutorial.html" target="_blank">持续集成服务 Travis CI 教程</a>，为什么还要写这篇文章？</p><p>原因有二：</p><ol start="1"><li>文章内容有些过时</li><li>文章覆盖度不够，有些实践细节没写出来</li></ol><p>由于以上原因，纵然可以笔者很快在Github集成Travis CI并成功构建，但在发布时却踩了一些坑，一直失败，折腾一波才终于发布成功。故写下此文，旨在补充更多的细节，帮助他人少走弯路。</p> <h1 id="正文"><a href="#正文" aria-hidden="true" class="header-anchor">#</a> 正文</h1> <h2 id="免费购买travis-ci应用"><a href="#免费购买travis-ci应用" aria-hidden="true" class="header-anchor">#</a> 免费购买Travis CI应用</h2> <p>点击 <a href="https://github.com/marketplace/travis-ci" target="_blank">https://github.com/marketplace/travis-ci</a>，登录后免费购买(<span>开源项目集成Travis CI不收费)</span>。</p> <h2 id="选择关联仓库"><a href="#选择关联仓库" aria-hidden="true" class="header-anchor">#</a> 选择关联仓库</h2> <p>选择个人或组织名下需要关联<span>Travis CI的</span>Github仓库。</p><p>已经设置过的，想进行修改，可以在Github的 Personal settings-&gt; Applications 中进入。</p><p><img src="https://cdn.nlark.com/yuque/0/2019/png/160590/1552699916365-0a309745-c830-480e-8c8f-58b2dde3f7bc.png#align=left&amp;display=inline&amp;height=285&amp;originHeight=381&amp;originWidth=227&amp;size=0&amp;status=done&amp;width=170" style="max-width:600px;width:170px;"><img alt="image.png" title="image.png" src="https://cdn.nlark.com/yuque/0/2019/png/160590/1552695398638-13ec5516-3002-4a74-bf08-099b32f2b612.png#align=left&amp;display=inline&amp;height=259&amp;name=image.png&amp;originHeight=958&amp;originWidth=1992&amp;size=408088&amp;status=done&amp;width=538" style="max-width:600px;width:538px;"></p><p><br><img alt="image.png" title="image.png" src="https://cdn.nlark.com/yuque/0/2019/png/160590/1552695750384-cc7d516e-c10d-4553-8811-84ac13f3ee4f.png#align=left&amp;display=inline&amp;height=316&amp;name=image.png&amp;originHeight=632&amp;originWidth=1340&amp;size=207631&amp;status=done&amp;width=670" style="max-width:600px;width:670px;"></p> <h2 id="编写ci文件"><a href="#编写ci文件" aria-hidden="true" class="header-anchor">#</a> 编写CI文件</h2> <p>在项目根目录下新建 <code>.travis.yml</code> 文件</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">touch</span> .travis.yml 
</code></pre></div><p>下面是一个实际使用的例子，可以直接复制粘贴使用。</p><p>该示例包含了：</p><ul><li>指定node.js版本</li><li>使用yarn进行安装依赖及构建</li><li>对安装需要的依赖进行了缓存</li><li>设置了两个不含敏感信息的环境变量</li><li>设置了一个含有敏感信息的环境变量</li><li>把构建生成的文件部署至github pages</li></ul> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">language</span><span class="token punctuation">:</span> node_js
<span class="token key atrule">node_js</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> lts/*
<span class="token key atrule">env</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> API_SERVER=https<span class="token punctuation">:</span>//easy<span class="token punctuation">-</span>mock.com/mock/5c1b3895fe5907404e654045/femessage<span class="token punctuation">-</span>mock PUBLIC_PATH=http<span class="token punctuation">:</span>//levy.work/nuxt<span class="token punctuation">-</span>element<span class="token punctuation">-</span>dashboard/
<span class="token key atrule">install</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> yarn
<span class="token key atrule">script</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> yarn build
<span class="token key atrule">cache</span><span class="token punctuation">:</span> yarn
<span class="token key atrule">deploy</span><span class="token punctuation">:</span>
 <span class="token key atrule">provider</span><span class="token punctuation">:</span> pages
 <span class="token key atrule">skip-cleanup</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
 <span class="token key atrule">keep-history</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
 <span class="token key atrule">local-dir</span><span class="token punctuation">:</span> dist
 <span class="token key atrule">on</span><span class="token punctuation">:</span>
   <span class="token key atrule">branch</span><span class="token punctuation">:</span> master
 <span class="token key atrule">github-token</span><span class="token punctuation">:</span> $GITHUB_TOKEN 
</code></pre></div><p>下面对文件进行说明。</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">language</span><span class="token punctuation">:</span> node_js
<span class="token key atrule">node_js</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> lts/* 
</code></pre></div><ul><li>第1行指定了构建环境为node.js</li><li>第2、3行指定使用node.js最新的LTS版本</li></ul> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">env</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> API_SERVER=xxx PUBLIC_PATH=xxx 
</code></pre></div><p>上面是设置两个环境变量。</p><p><span style="color:#F5222D;">注意，一次构建中传多个环境变量，</span><span style="color:#F5222D;">必须写在同一行，使用空格分开。</span></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">env</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> API_SERVER=xxx 
<span class="token punctuation">-</span> PUBLIC_PATH=xxx 
</code></pre></div><p><span>如果写成上面的形式，则会变成两个构建，每一个构建中只有一个环境变量。</span></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">install</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> yarn
<span class="token key atrule">script</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> yarn build
<span class="token key atrule">cache</span><span class="token punctuation">:</span> yarn 
</code></pre></div><p>上面指定使用yarn进行安装依赖，安装好后执行 <code>yarn build</code> 命令; 为yarn的依赖加速安装，开启了缓存。</p><p>下面是最关键的部署配置。</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">deploy</span><span class="token punctuation">:</span>
 <span class="token key atrule">provider</span><span class="token punctuation">:</span> pages
 <span class="token key atrule">skip-cleanup</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
 <span class="token key atrule">keep-history</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
 <span class="token key atrule">local-dir</span><span class="token punctuation">:</span> dist
 <span class="token key atrule">on</span><span class="token punctuation">:</span>
   <span class="token key atrule">branch</span><span class="token punctuation">:</span> master
 <span class="token key atrule">github-token</span><span class="token punctuation">:</span> $GITHUB_TOKEN 
</code></pre></div><ul><li>第2行指定部署到Github Pages，即仓库的 <code>gh-pages</code> 分支，请确保仓库的pages分支是 <code>gh-pages</code> , <a href="#b637c71e">相关操作可以看这里</a></li><li>第3行指定保留构建后的文件</li><li>第4行指定每次部署会新增一个提交记录再推送，而不是使用 <code>git push --force</code></li><li>第5行指定构建后要部署的目录</li><li>第6、7行指<span>定</span> <code><span>master</span></code> 分支有提交行为时，将触发构建后部署</li><li>第8行是部署需要用到的<code>github-token</code>,其中<code>$GITHUB_TOKEN</code>是变量，它可以在Travis CI个人仓库的setting页里设置，<a href="#74ae38aa">相关操作可以看这里</a></li></ul> <h2 id="相关操作"><a href="#相关操作" aria-hidden="true" class="header-anchor">#</a> 相关操作</h2> <h3 id="github-pages"><a href="#github-pages" aria-hidden="true" class="header-anchor">#</a> GitHub Pages</h3> <p><span>查看</span><code><span>gh-pages</span></code>分支的部署情况</p><p>进入仓库 Settings -&gt; Options</p><p><br><img alt="image.png" title="image.png" src="https://cdn.nlark.com/yuque/0/2019/png/160590/1552699596402-08204f8a-5f36-4986-abb7-e0b3eaa7ab6e.png#align=left&amp;display=inline&amp;height=100&amp;name=image.png&amp;originHeight=200&amp;originWidth=1606&amp;size=114488&amp;status=done&amp;width=803" style="max-width:600px;width:803px;"></p><p>往下翻看，可以看到效果</p><p><img alt="image.png" title="image.png" src="https://cdn.nlark.com/yuque/0/2019/png/160590/1552699631605-7b018c4a-9e4f-4405-9423-9345f3ab16e3.png#align=left&amp;display=inline&amp;height=244&amp;name=image.png&amp;originHeight=488&amp;originWidth=1380&amp;size=278744&amp;status=done&amp;width=690" style="max-width:600px;width:690px;"></p><p><span>因为笔者自定义了域名，所以地址不是默认的 https://xxx.github.io/xxx</span></p> <h3 id="设置github-token"><a href="#设置github-token" aria-hidden="true" class="header-anchor">#</a> 设置GITHUB_TOKEN</h3> <p>首先为Travis CI新建一个token</p><p><img src="https://cdn.nlark.com/yuque/0/2019/png/160590/1552699916365-0a309745-c830-480e-8c8f-58b2dde3f7bc.png#align=left&amp;display=inline&amp;height=285&amp;name=&amp;originHeight=381&amp;originWidth=227&amp;status=done&amp;width=170" style="max-width:600px;width:170px;"><img src="https://cdn.nlark.com/yuque/0/2019/png/160590/1552699974567-7208da19-fdb5-4c43-b19b-61acfb4c4783.png#align=left&amp;display=inline&amp;height=184&amp;name=&amp;originHeight=184&amp;originWidth=254&amp;size=0&amp;status=done&amp;width=254" style="max-width:600px;width:254px;"><a href="https://help.github.com/assets/images/help/settings/personal_access_tokens_tab.png" target="_blank"></a><img src="https://cdn.nlark.com/yuque/0/2019/png/160590/1552700133575-16c48b5a-fe9c-4eb4-a6ab-cf4e066d5881.png#align=left&amp;display=inline&amp;height=204&amp;name=&amp;originHeight=204&amp;originWidth=262&amp;size=0&amp;status=done&amp;width=262" style="max-width:600px;width:262px;"></p><p>点击生成新token</p><p><a href="https://help.github.com/assets/images/help/settings/generate_new_token.png" target="_blank"></a><img src="https://cdn.nlark.com/yuque/0/2019/png/160590/1552700229186-44a679d9-254f-4377-94bd-ac115e345cec.png#align=left&amp;display=inline&amp;height=64&amp;name=&amp;originHeight=82&amp;originWidth=961&amp;size=0&amp;status=done&amp;width=746" style="max-width:600px;width:746px;"></p><p>设置权限</p><p><br><img alt="image.png" title="image.png" src="https://cdn.nlark.com/yuque/0/2019/png/160590/1552700351510-569e8cad-ecc4-420a-a7c0-d94cf87a6632.png#align=left&amp;display=inline&amp;height=516&amp;name=image.png&amp;originHeight=1032&amp;originWidth=1228&amp;size=598324&amp;status=done&amp;width=614" style="max-width:600px;width:614px;"></p><p>复制生成的token。(记得先不要刷新或离开当前页面，否则token就看不见了，只能重新生成)</p><p>登录Travis CI, 进入要集成的项目设置页。</p><p><br><img alt="image.png" title="image.png" src="https://cdn.nlark.com/yuque/0/2019/png/160590/1552700606763-80259a22-e30e-474e-ae50-c31958367f1f.png#align=left&amp;display=inline&amp;height=348&amp;name=image.png&amp;originHeight=696&amp;originWidth=2540&amp;size=434279&amp;status=done&amp;width=1270" style="max-width:600px;width:1270px;"></p><p>添加环境变量<code><span>GITHUB_TOKEN</span></code></p><p><span style="color:#F5222D;">注意，这里的环境变量是通过bash设置、并在.yml里读取的，所以变量名是大写加下划线形式，这是bash的最佳实践，千万别写成</span><code><span>github-token</span></code></p><p><img alt="image.png" title="image.png" src="https://cdn.nlark.com/yuque/0/2019/png/160590/1552700692945-dc8dc616-6829-4c2b-afae-9150ba001398.png#align=left&amp;display=inline&amp;height=300&amp;name=image.png&amp;originHeight=600&amp;originWidth=1906&amp;size=226858&amp;status=done&amp;width=953" style="max-width:600px;width:953px;"></p><p>好了，在master分支上推送一下，试试新鲜出炉的CI服务吧！</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.5ecd04e8.js" defer></script><script src="/blog/assets/js/2.7a69aa7d.js" defer></script><script src="/blog/assets/js/14.85d14865.js" defer></script>
  </body>
</html>
