(window.webpackJsonp=window.webpackJsonp||[]).push([[28],{224:function(t,s,a){"use strict";a.r(s);var n=a(2),e=Object(n.a)({},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"🔒免费开启https"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#🔒免费开启https","aria-hidden":"true"}},[t._v("#")]),t._v(" 🔒免费开启HTTPS")]),t._v(" "),a("h2",{attrs:{id:"前言"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#前言","aria-hidden":"true"}},[t._v("#")]),t._v(" 前言")]),t._v(" "),a("p",[t._v("本文将分享几种为站点启用HTTPS的方法，内容包括：")]),t._v(" "),a("ol",[a("li",[t._v("免费证书的获取及安装")]),t._v(" "),a("li",[t._v("为Node.js应用开启HTTPS")]),t._v(" "),a("li",[t._v("为Nginx开启HTTPS")])]),t._v(" "),a("h2",{attrs:{id:"前提准备"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#前提准备","aria-hidden":"true"}},[t._v("#")]),t._v(" 前提准备")]),t._v(" "),a("ol",[a("li",[t._v("一台拥有外网IP的服务器(假设操作系统为: "),a("code",[t._v("CentOS 7.4")]),t._v(")")]),t._v(" "),a("li",[t._v("一个域名(解析到上述服务器的IP)(假设域名为: "),a("code",[t._v("www.example.com")]),t._v(")")]),t._v(" "),a("li",[t._v("SSL证书")])]),t._v(" "),a("h2",{attrs:{id:"证书"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#证书","aria-hidden":"true"}},[t._v("#")]),t._v(" 证书")]),t._v(" "),a("h3",{attrs:{id:"symantec"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#symantec","aria-hidden":"true"}},[t._v("#")]),t._v(" Symantec")]),t._v(" "),a("p",[t._v("阿里云可以购买有效期一年的免费证书，审核时间大概10分钟，优点是域名不用备案。强烈推荐。"),a("br"),a("img",{attrs:{src:"https://tva1.sinaimg.cn/large/006y8mN6gy1g6mahokwk5j31v80nuwkj.jpg",alt:"image.png"}})]),t._v(" "),a("p",[t._v("购买后，点击下载"),a("br"),a("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2019/png/160590/1555253388293-a7c2c868-b192-4b70-8b0d-ec0a3dab8bd7.png#align=left&display=inline&height=357&name=image.png&originHeight=714&originWidth=636&size=140302&status=done&width=318",alt:"image.png"}}),a("br"),t._v("即可获得证书")]),t._v(" "),a("h3",{attrs:{id:"letsencrypt"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#letsencrypt","aria-hidden":"true"}},[t._v("#")]),t._v(" letsencrypt")]),t._v(" "),a("p",[t._v("虽然是免费的，但安装比较费时间，如果网络不太好，会很捉急。")]),t._v(" "),a("p",[t._v("其证书获取方式后文会讲。")]),t._v(" "),a("h2",{attrs:{id:"node-js应用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#node-js应用","aria-hidden":"true"}},[t._v("#")]),t._v(" Node.js应用")]),t._v(" "),a("p",[t._v("下面以koa2构建node.js应用 + Symantec为例，说明如何为接口开启https。")]),t._v(" "),a("p",[t._v("在项目根目录新建文件夹")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ssh")]),t._v("\n")])])]),a("p",[t._v("把Symantec的证书文件放到该目录下。")]),t._v(" "),a("p",[t._v("假设两个文件的名称分别为： "),a("code",[t._v("server.key")]),t._v(" "),a("code",[t._v("server.pem")])]),t._v(" "),a("p",[t._v("新建"),a("code",[t._v("index.js")]),t._v("文件")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("touch")]),t._v(" index.js\n")])])]),a("p",[t._v("编写以下代码")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" koa "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'koa'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" app "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("koa")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" port "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" process"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("env"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("PORT")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3000")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" https "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'https'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" fs "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'fs'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" sslOptions "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" fs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("readFileSync")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./ssl/server.key'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  cert"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" fs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("readFileSync")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./ssl/server.pem'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\nhttps"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("createServer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sslOptions"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("callback")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("listen")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("port"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'server start up at https://localhost:'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" port"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("p",[t._v("启动应用即可看到效果。")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("node index.js\n")])])]),a("h2",{attrs:{id:"nginx代理静态资源"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#nginx代理静态资源","aria-hidden":"true"}},[t._v("#")]),t._v(" Nginx代理静态资源")]),t._v(" "),a("p",[t._v("下面讲解如何在CentOS机器上，使用Nginx + letsencrypt为静态网站开启HTTPS。")]),t._v(" "),a("p",[t._v("注: "),a("a",{attrs:{href:"https://coolshell.cn/articles/18094.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Ubuntu版本参考这里"),a("OutboundLink")],1)]),t._v(" "),a("p",[t._v("1.首先更新yum仓库(需要等待一段时间)")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("yum update\n")])])]),a("p",[t._v("2.安装Nginx")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("yum "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" nginx\n")])])]),a("p",[t._v("可以先跑一下Nginx")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("nginx\n")])])]),a("p",[t._v("然后在浏览器访问"),a("code",[t._v("www.example.com")]),t._v(", 如果看到Nginx的欢迎页, 说明安装成功")]),t._v(" "),a("p",[t._v("3.安装letsencrypt以获取免费证书")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("yum "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" letsencrypt\n")])])]),a("p",[t._v("修改Nginx配置:")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("vi")]),t._v(" /etc/nginx/nginx.conf\n")])])]),a("p",[t._v("找到80关键字，强制对80端口的请求重定向到HTTPS协议")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("server "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  listen 80"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  location / "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 补充下面一行")]),t._v("\n\t  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" 302 https://"),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$host")]),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$request_uri")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("找到443关键字, 把注释打开, 即把"),a("code",[t._v("#")]),t._v("去掉")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# HTTPS server")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 把下面的注释全部打开")]),t._v("\nserver "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  listen       443 ssl http2 default_server"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  server_name  localhost"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  ssl_certificate      cert.pem"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  ssl_certificate_key  cert.key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  ssl_session_cache    shared:SSL:1m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  ssl_session_timeout  5m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  ssl_ciphers  HIGH:"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("aNULL:"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("MD5"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  ssl_prefer_server_ciphers  on"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  location / "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    root   html"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    index  index.html index.htm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("假设静态文件的根路径为 "),a("code",[t._v("/path/dir")]),t._v(", 把它写在Nginx配置文件里")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("location / "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 修改下面一行")]),t._v("\n  root   /path/dir"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  index  index.html index.htm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("根据路径以及域名，生成证书及密钥")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" letsencrypt certonly -a webroot --webroot-path"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/path/dir -d www.example.com\n")])])]),a("p",[t._v("成功后, 控制后会打印出生成文件的路径, 把它们写在Nginx配置文件里")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("ssl_certificate "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/etc/letsencrypt/live/www.example.com/fullchain.pem"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nssl_certificate_key "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/etc/letsencrypt/live/www.example.com/privkey.pem"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("4.查检openssl版本")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("openssl version\n")])])]),a("p",[t._v("如果版本大于等于"),a("code",[t._v("1.02")]),t._v(", 那就是ok的, 否则, 需要升级openssl.")]),t._v(" "),a("p",[t._v("如何升级? 如果使用最新内核的Linux操作系统, 是不会遇到这种问题的, 真的遇到了, 自己google吧😄")]),t._v(" "),a("p",[t._v("5.重启Nginx")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("nginx -s reload\n")])])]),a("p",[t._v("重新访问你的站点, 发现地址栏多了一把绿色的锁, 恭喜, 这正是使用HTTPS协议的标志!")]),t._v(" "),a("p",[t._v("6.定期更新证书")]),t._v(" "),a("p",[t._v("因为Let’s Encrypt 的证书90天就过期了, 所以可以写个定时任务")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("crontab")]),t._v(" -e\n")])])]),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("0 0 * * 1 /usr/bin/letsencrypt renew "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),t._v(" /var/log/letsencrypt-renew.log\n5 0 * * 1 /bin/systemctl reload nginx\n")])])]),a("p",[t._v("每星期1的0点0分执行更新操作，0点5分执行Nginx 重启")]),t._v(" "),a("h2",{attrs:{id:"注"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#注","aria-hidden":"true"}},[t._v("#")]),t._v(" 注")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://github.com/levy9527/blog/issues/5",target:"_blank",rel:"noopener noreferrer"}},[t._v("原文地址"),a("OutboundLink")],1)])])},[],!1,null,null,null);s.default=e.exports}}]);