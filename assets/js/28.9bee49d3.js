(window.webpackJsonp=window.webpackJsonp||[]).push([[28],{224:function(s,t,a){"use strict";a.r(t);var n=a(2),e=Object(n.a)({},function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"🔒免费开启https"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#🔒免费开启https","aria-hidden":"true"}},[s._v("#")]),s._v(" 🔒免费开启HTTPS")]),s._v(" "),a("h2",{attrs:{id:"前言"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#前言","aria-hidden":"true"}},[s._v("#")]),s._v(" 前言")]),s._v(" "),a("p",[s._v("本文将分享几种为站点启用HTTPS的方法，内容包括：")]),s._v(" "),a("ol",[a("li",[s._v("免费证书的获取及安装")]),s._v(" "),a("li",[s._v("为Node.js应用开启HTTPS")]),s._v(" "),a("li",[s._v("为Nginx开启HTTPS")])]),s._v(" "),a("h2",{attrs:{id:"前提准备"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#前提准备","aria-hidden":"true"}},[s._v("#")]),s._v(" 前提准备")]),s._v(" "),a("ol",[a("li",[s._v("一台拥有外网IP的服务器(假设操作系统为: "),a("code",[s._v("CentOS 7.4")]),s._v(")")]),s._v(" "),a("li",[s._v("一个域名(解析到上述服务器的IP)(假设域名为: "),a("code",[s._v("www.example.com")]),s._v(")")]),s._v(" "),a("li",[s._v("SSL证书")])]),s._v(" "),a("h2",{attrs:{id:"证书"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#证书","aria-hidden":"true"}},[s._v("#")]),s._v(" 证书")]),s._v(" "),a("h3",{attrs:{id:"symantec"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#symantec","aria-hidden":"true"}},[s._v("#")]),s._v(" Symantec")]),s._v(" "),a("p",[s._v("阿里云可以购买有效期一年的免费证书，审核时间大概10分钟，优点是域名不用备案。强烈推荐。"),a("br"),a("img",{attrs:{src:"https://tva1.sinaimg.cn/large/006y8mN6gy1g6mahokwk5j31v80nuwkj.jpg",alt:"image.png"}})]),s._v(" "),a("p",[s._v("购买后，点击下载"),a("br"),a("img",{attrs:{src:"https://tva1.sinaimg.cn/large/006y8mN6gy1g6mc5kffb4j30ho0jut9x.jpg",alt:"image.png"}}),a("br"),s._v("即可获得证书")]),s._v(" "),a("h3",{attrs:{id:"letsencrypt"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#letsencrypt","aria-hidden":"true"}},[s._v("#")]),s._v(" letsencrypt")]),s._v(" "),a("p",[s._v("虽然是免费的，但安装比较费时间，如果网络不太好，会很捉急。")]),s._v(" "),a("p",[s._v("其证书获取方式后文会讲。")]),s._v(" "),a("h2",{attrs:{id:"node-js应用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#node-js应用","aria-hidden":"true"}},[s._v("#")]),s._v(" Node.js应用")]),s._v(" "),a("p",[s._v("下面以koa2构建node.js应用 + Symantec为例，说明如何为接口开启https。")]),s._v(" "),a("p",[s._v("在项目根目录新建文件夹")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v("\n")])])]),a("p",[s._v("把Symantec的证书文件放到该目录下。")]),s._v(" "),a("p",[s._v("假设两个文件的名称分别为： "),a("code",[s._v("server.key")]),s._v(" "),a("code",[s._v("server.pem")])]),s._v(" "),a("p",[s._v("新建"),a("code",[s._v("index.js")]),s._v("文件")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("touch")]),s._v(" index.js\n")])])]),a("p",[s._v("编写以下代码")]),s._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" koa "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'koa'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" app "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("koa")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" port "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" process"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("env"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("PORT")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("||")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3000")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" https "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'https'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" fs "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'fs'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" sslOptions "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" fs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("readFileSync")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'./ssl/server.key'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  cert"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" fs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("readFileSync")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'./ssl/server.pem'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\nhttps"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("createServer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("sslOptions"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("callback")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("listen")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("port"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'server start up at https://localhost:'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" port"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])])]),a("p",[s._v("启动应用即可看到效果。")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("node index.js\n")])])]),a("h2",{attrs:{id:"nginx代理静态资源"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#nginx代理静态资源","aria-hidden":"true"}},[s._v("#")]),s._v(" Nginx代理静态资源")]),s._v(" "),a("p",[s._v("下面讲解如何在CentOS机器上，使用Nginx + letsencrypt为静态网站开启HTTPS。")]),s._v(" "),a("p",[s._v("注: "),a("a",{attrs:{href:"https://coolshell.cn/articles/18094.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("Ubuntu版本参考这里"),a("OutboundLink")],1)]),s._v(" "),a("p",[s._v("1.首先更新yum仓库(需要等待一段时间)")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("yum update\n")])])]),a("p",[s._v("2.安装Nginx")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("yum "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" nginx\n")])])]),a("p",[s._v("可以先跑一下Nginx")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("nginx\n")])])]),a("p",[s._v("然后在浏览器访问"),a("code",[s._v("www.example.com")]),s._v(", 如果看到Nginx的欢迎页, 说明安装成功")]),s._v(" "),a("p",[s._v("3.安装letsencrypt以获取免费证书")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("yum "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" letsencrypt\n")])])]),a("p",[s._v("修改Nginx配置:")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vi")]),s._v(" /etc/nginx/nginx.conf\n")])])]),a("p",[s._v("找到80关键字，强制对80端口的请求重定向到HTTPS协议")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("server "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  listen 80"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  location / "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 补充下面一行")]),s._v("\n\t  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" 302 https://"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$host")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$request_uri")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),a("p",[s._v("找到443关键字, 把注释打开, 即把"),a("code",[s._v("#")]),s._v("去掉")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# HTTPS server")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 把下面的注释全部打开")]),s._v("\nserver "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  listen       443 ssl http2 default_server"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  server_name  localhost"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n  ssl_certificate      cert.pem"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  ssl_certificate_key  cert.key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n  ssl_session_cache    shared:SSL:1m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  ssl_session_timeout  5m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n  ssl_ciphers  HIGH:"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("aNULL:"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("MD5"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  ssl_prefer_server_ciphers  on"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n  location / "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    root   html"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    index  index.html index.htm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),a("p",[s._v("假设静态文件的根路径为 "),a("code",[s._v("/path/dir")]),s._v(", 把它写在Nginx配置文件里")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("location / "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 修改下面一行")]),s._v("\n  root   /path/dir"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  index  index.html index.htm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),a("p",[s._v("根据路径以及域名，生成证书及密钥")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" letsencrypt certonly -a webroot --webroot-path"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/path/dir -d www.example.com\n")])])]),a("p",[s._v("成功后, 控制后会打印出生成文件的路径, 把它们写在Nginx配置文件里")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("ssl_certificate "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/etc/letsencrypt/live/www.example.com/fullchain.pem"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nssl_certificate_key "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/etc/letsencrypt/live/www.example.com/privkey.pem"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),a("p",[s._v("4.查检openssl版本")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("openssl version\n")])])]),a("p",[s._v("如果版本大于等于"),a("code",[s._v("1.02")]),s._v(", 那就是ok的, 否则, 需要升级openssl.")]),s._v(" "),a("p",[s._v("如何升级? 如果使用最新内核的Linux操作系统, 是不会遇到这种问题的, 真的遇到了, 自己google吧😄")]),s._v(" "),a("p",[s._v("5.重启Nginx")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("nginx -s reload\n")])])]),a("p",[s._v("重新访问你的站点, 发现地址栏多了一把绿色的锁, 恭喜, 这正是使用HTTPS协议的标志!")]),s._v(" "),a("p",[s._v("6.定期更新证书")]),s._v(" "),a("p",[s._v("因为Let’s Encrypt 的证书90天就过期了, 所以可以写个定时任务")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("crontab")]),s._v(" -e\n")])])]),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("0 0 * * 1 /usr/bin/letsencrypt renew "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" /var/log/letsencrypt-renew.log\n5 0 * * 1 /bin/systemctl reload nginx\n")])])]),a("p",[s._v("每星期1的0点0分执行更新操作，0点5分执行Nginx 重启")]),s._v(" "),a("h2",{attrs:{id:"注"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#注","aria-hidden":"true"}},[s._v("#")]),s._v(" 注")]),s._v(" "),a("p",[a("a",{attrs:{href:"https://github.com/levy9527/blog/issues/5",target:"_blank",rel:"noopener noreferrer"}},[s._v("原文地址"),a("OutboundLink")],1)])])},[],!1,null,null,null);t.default=e.exports}}]);